const APP_VERSION='v8';const StorageKey={Config:`pomodoro_config_${APP_VERSION}`,Schedule:`pomodoro_schedule_${APP_VERSION}`,State:`pomodoro_state_${APP_VERSION}`,Theme:`pomodoro_theme_${APP_VERSION}`};const SessionType={Work:'work',ShortBreak:'short-break',LongBreak:'long-break'};const DEFAULTS={startTime:'09:00',totalSessions:10,workDuration:25,shortBreakDuration:10,longBreakDuration:25,sessionsBeforeLongBreak:5,autoStart:false,soundEnabled:true,timerStyle:'digital'};class Utils{static audioContext=null;static formatDuration(minutes){return`${Math.floor(minutes/60)}h ${minutes%60}m`;}static formatTimerDisplay(seconds){if(typeof seconds!=='number'||seconds<0)seconds=0;return`${String(Math.floor(seconds/60)).padStart(2,'0')}:${String(seconds%60).padStart(2,'0')}`;}static formatDateTime(date){const days=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];const months=['January','February','March','April','May','June','July','August','September','October','November','December'];return{date:`${days[date.getDay()]}, ${months[date.getMonth()]} ${date.getDate()}, ${date.getFullYear()}`,time:`${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}:${String(date.getSeconds()).padStart(2,'0')}`};}static getCurrentTimeForInput(){const now=new Date();now.setMinutes(now.getMinutes()+1);return`${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;}static getExactCurrentTime(){const now=new Date();return`${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;}static getSessionLabel(session){if(!session)return'Unknown';if(session.type===SessionType.LongBreak)return'Long Break';if(session.type===SessionType.ShortBreak)return'Short Break';return`Work Session ${session.sessionNumber}`;}static requestAudioContextOnGesture(){if(!Utils.audioContext){try{Utils.audioContext=new(window.AudioContext||window.webkitAudioContext)();}catch(e){console.warn('AudioContext creation failed:',e);}}}static playNotification(){try{Utils.requestAudioContextOnGesture();const ac=Utils.audioContext;if(!ac)return;const osc=ac.createOscillator();const gain=ac.createGain();osc.connect(gain);gain.connect(ac.destination);gain.gain.setValueAtTime(0.16,ac.currentTime);gain.gain.exponentialRampToValueAtTime(0.001,ac.currentTime+0.5);osc.frequency.setValueAtTime(880,ac.currentTime);osc.type='sine';osc.start();osc.stop(ac.currentTime+0.45);}catch(e){console.warn('playNotification failed',e);}}}class Storage{static save(key,data){try{localStorage.setItem(key,JSON.stringify(data));}catch(e){console.warn('Storage save failed',e);}}static load(key){try{const raw=localStorage.getItem(key);return raw?JSON.parse(raw):null;}catch(e){return null;}}}class ScheduleGenerator{static generate(config){const sessions=[];let currentTime=this._parseTime(config.startTime);let workCounter=0;while(workCounter<config.totalSessions){workCounter++;sessions.push(this._createSession(workCounter,new Date(currentTime),config.workDuration,SessionType.Work));currentTime=new Date(currentTime.getTime()+config.workDuration*60000);if(workCounter<config.totalSessions){const isLong=workCounter%config.sessionsBeforeLongBreak===0;const dur=isLong?config.longBreakDuration:config.shortBreakDuration;const type=isLong?SessionType.LongBreak:SessionType.ShortBreak;sessions.push(this._createSession(null,new Date(currentTime),dur,type));currentTime=new Date(currentTime.getTime()+dur*60000);}}return sessions;}static _createSession(sessionNumber,startTime,duration,type){return{id:typeof crypto!=='undefined'&&crypto.randomUUID?crypto.randomUUID():`${Date.now()}-${Math.random().toString(36).slice(2)}`,sessionNumber,startTime:new Date(startTime),endTime:new Date(startTime.getTime()+duration*60000),duration,type,completed:false};}static _parseTime(timeString){const today=new Date();const[hours,minutes]=(timeString||'09:00').split(':').map(Number);let dt=new Date(today.getFullYear(),today.getMonth(),today.getDate(),hours,minutes,0);if(dt.getTime()<Date.now())dt=new Date(dt.getTime()+24*60*60*1000);return dt;}}class View{constructor(){this.dom={dtDate:document.getElementById('dt-date'),dtTime:document.getElementById('dt-time'),timerDisplay:document.getElementById('timer-display'),sessionBadge:document.getElementById('session-badge'),sessionNumber:document.getElementById('session-number'),timerRingProgress:document.getElementById('timer-ring-progress'),digitalTimer:document.getElementById('digital-timer'),analogTimer:document.getElementById('analog-timer'),analogProgress:document.getElementById('analog-progress'),analogTimeDisplay:document.getElementById('analog-time-display'),analogSessionBadge:document.getElementById('analog-session-badge'),analogSessionNumber:document.getElementById('analog-session-number'),hourHand:document.getElementById('hour-hand'),minuteHand:document.getElementById('minute-hand'),secondHand:document.getElementById('second-hand'),startBtn:document.getElementById('start-btn'),pauseBtn:document.getElementById('pause-btn'),skipBtn:document.getElementById('skip-btn'),resetBtn:document.getElementById('reset-btn'),configBtn:document.getElementById('config-btn'),configOverlay:document.getElementById('config-overlay'),closeConfig:document.getElementById('close-config'),configForm:document.getElementById('config-form'),timeline:document.getElementById('timeline'),statTotal:document.getElementById('stat-total'),statCompleted:document.getElementById('stat-completed'),statRemaining:document.getElementById('stat-remaining'),statDuration:document.getElementById('stat-duration'),toastContainer:document.getElementById('toast-container'),themeColorMeta:document.getElementById('theme-color-meta'),autoStartToggle:document.getElementById('auto-start-toggle'),soundToggle:document.getElementById('sound-toggle'),useNowBtn:document.getElementById('use-now-btn'),inputs:{startTime:document.getElementById('start-time'),totalSessions:document.getElementById('total-sessions'),workDuration:document.getElementById('work-duration'),shortBreakDuration:document.getElementById('short-break'),longBreakDuration:document.getElementById('long-break'),sessionsBeforeLongBreak:document.getElementById('sessions-before-long')}};this.circumference=2*Math.PI*90;this._initClock();this._initAnalog();lucide.createIcons();this._startClockInterval();this._maybeCreateParticles();}_startClockInterval(){this._updateClock();this._clockInterval=setInterval(()=>this._updateClock(),1000);}_updateClock(){const now=new Date();const{date,time}=Utils.formatDateTime(now);if(this.dom.dtDate)this.dom.dtDate.textContent=date;if(this.dom.dtTime)this.dom.dtTime.textContent=time;}_initAnalog(){const tickMarks=document.getElementById('tick-marks');if(tickMarks){for(let i=0;i<60;i++){const tick=document.createElement('div');tick.className=i%5===0?'tick major':'tick';tick.style.transform=`rotate(${i*6}deg)`;tickMarks.appendChild(tick);}}const numbers=document.getElementById('clock-numbers');if(numbers){for(let i=1;i<=12;i++){const angle=(i*30-90)*Math.PI/180;const x=50+38*Math.cos(angle);const y=50+38*Math.sin(angle);const num=document.createElement('div');num.className='clock-number';num.textContent=i;num.style.left=`${x}%`;num.style.top=`${y}%`;numbers.appendChild(num);}}}_maybeCreateParticles(){const container=document.getElementById('particles');if(!container)return;if(window.matchMedia&&window.matchMedia('(prefers-reduced-motion: reduce)').matches)return;const count=window.innerWidth<600?12:30;for(let i=0;i<count;i++){const p=document.createElement('div');p.className='particle';p.style.left=`${Math.random()*100}%`;p.style.top=`${Math.random()*100}%`;p.style.animationDelay=`${Math.random()*20}s`;p.style.animationDuration=`${15+Math.random()*10}s`;container.appendChild(p);}}render(state){if(!state.sessions||state.sessions.length===0)return;this.renderTimer(state);this.renderStats(state);const fingerprint=JSON.stringify(state.sessions.map(s=>({id:s.id,completed:s.completed})));if(this._lastFingerprint!==fingerprint||this._lastIndex!==state.currentSessionIndex){this.renderTimeline(state);this._lastFingerprint=fingerprint;this._lastIndex=state.currentSessionIndex;}this.updateButtons(state.isRunning);}renderTimer(state){const current=state.sessions[state.currentSessionIndex];if(!current)return;const timeDisplay=Utils.formatTimerDisplay(state.remainingSeconds);const workSessions=state.sessions.filter(s=>s.type===SessionType.Work);const currentWorkIndex=workSessions.findIndex(s=>s.sessionNumber===current.sessionNumber)+1;const sessionText=current.type===SessionType.Work?`Session ${currentWorkIndex} of ${workSessions.length}`:'Break Time';const badgeText=(current.type||'').replace('-',' ');const colors={[SessionType.Work]:{color:'var(--accent-work)'},[SessionType.ShortBreak]:{color:'var(--accent-break)'},[SessionType.LongBreak]:{color:'var(--accent-long)'}};const color=(colors[current.type]&&colors[current.type].color)||'var(--accent-work)';const progress=Math.max(0,Math.min(1,state.remainingSeconds/(current.duration*60)));const dashOffset=this.circumference*(1-progress);if(state.config.timerStyle==='digital'){if(this.dom.timerDisplay)this.dom.timerDisplay.textContent=timeDisplay;if(this.dom.sessionBadge)this.dom.sessionBadge.textContent=badgeText;if(this.dom.sessionNumber)this.dom.sessionNumber.textContent=sessionText;if(this.dom.timerRingProgress){this.dom.timerRingProgress.style.strokeDashoffset=dashOffset;this.dom.timerRingProgress.style.stroke=color;}if(this.dom.sessionBadge)this.dom.sessionBadge.style.background=color;}else{if(this.dom.analogTimeDisplay)this.dom.analogTimeDisplay.textContent=timeDisplay;if(this.dom.analogSessionBadge)this.dom.analogSessionBadge.textContent=badgeText;if(this.dom.analogSessionNumber)this.dom.analogSessionNumber.textContent=sessionText;if(this.dom.analogProgress){this.dom.analogProgress.style.strokeDashoffset=dashOffset;this.dom.analogProgress.style.stroke=color;}const totalSeconds=current.duration*60;const elapsedSeconds=totalSeconds-Math.max(0,state.remainingSeconds);const elapsedProgress=Math.max(0,Math.min(1,elapsedSeconds/totalSeconds));const angle=elapsedProgress*360;if(this.dom.secondHand)this.dom.secondHand.style.transform=`rotate(${angle}deg)`;if(this.dom.minuteHand)this.dom.minuteHand.style.transform=`rotate(${angle}deg)`;if(this.dom.hourHand)this.dom.hourHand.style.transform=`rotate(${angle/12}deg)`;}document.title=`${timeDisplay} - ${badgeText.charAt(0).toUpperCase()+badgeText.slice(1)} â€¢ Pomodoro`;}renderStats(state){const workSessions=state.sessions.filter(s=>s.type===SessionType.Work);const completed=workSessions.filter(s=>s.completed).length;if(this.dom.statTotal)this.dom.statTotal.textContent=workSessions.length;if(this.dom.statCompleted)this.dom.statCompleted.textContent=completed;if(this.dom.statRemaining)this.dom.statRemaining.textContent=Math.max(0,workSessions.length-completed);const totalDuration=state.sessions.reduce((t,s)=>t+(s.duration||0),0);if(this.dom.statDuration)this.dom.statDuration.textContent=Utils.formatDuration(totalDuration);}renderTimeline(state){if(!this.dom.timeline)return;this.dom.timeline.innerHTML='';state.sessions.forEach((session,index)=>{const item=document.createElement('div');item.className='timeline-item';if(session.completed)item.classList.add('completed');if(index===state.currentSessionIndex)item.classList.add('active');const dot=document.createElement('div');dot.className='timeline-dot';item.appendChild(dot);const card=document.createElement('div');card.className='timeline-card';const typeEl=document.createElement('div');typeEl.className='timeline-type';typeEl.textContent=session.type.replace('-',' ');const label=document.createElement('div');label.className='timeline-label';label.textContent=Utils.getSessionLabel(session);const time=document.createElement('div');time.className='timeline-time';time.textContent=`${this._formatTime(session.startTime)} - ${this._formatTime(session.endTime)} (${session.duration}m)`;card.appendChild(typeEl);card.appendChild(label);card.appendChild(time);item.appendChild(card);this.dom.timeline.appendChild(item);});}_formatTime(d){return new Date(d).toTimeString().slice(0,5);}updateButtons(isRunning){if(this.dom.startBtn)this.dom.startBtn.classList.toggle('hidden',!!isRunning);if(this.dom.pauseBtn)this.dom.pauseBtn.classList.toggle('hidden',!isRunning);}setTimerStyle(style){if(style==='digital'){if(this.dom.digitalTimer)this.dom.digitalTimer.classList.remove('hidden');if(this.dom.analogTimer)this.dom.analogTimer.classList.add('hidden');}else{if(this.dom.digitalTimer)this.dom.digitalTimer.classList.add('hidden');if(this.dom.analogTimer)this.dom.analogTimer.classList.remove('hidden');}}toggleConfig(show){if(!this.dom.configOverlay)return;this.dom.configOverlay.hidden=!show;this.dom.configOverlay.setAttribute('aria-hidden',String(!show));if(show&&this.dom.inputs.startTime)this.dom.inputs.startTime.focus();}loadConfigToForm(config){for(const key in this.dom.inputs){if(this.dom.inputs[key]&&config[key]!==undefined){this.dom.inputs[key].value=config[key];}}if(!config.startTime||config.startTime===DEFAULTS.startTime){if(this.dom.inputs.startTime)this.dom.inputs.startTime.value=Utils.getCurrentTimeForInput();}if(this.dom.autoStartToggle){this.dom.autoStartToggle.classList.toggle('active',!!config.autoStart);this.dom.autoStartToggle.setAttribute('aria-checked',config.autoStart?'true':'false');}if(this.dom.soundToggle){this.dom.soundToggle.classList.toggle('active',!!config.soundEnabled);this.dom.soundToggle.setAttribute('aria-checked',config.soundEnabled?'true':'false');}document.querySelectorAll('.radio-option').forEach(opt=>{opt.classList.toggle('active',opt.dataset.timerStyle===config.timerStyle);opt.setAttribute('aria-checked',opt.dataset.timerStyle===config.timerStyle?'true':'false');});this.setTimerStyle(config.timerStyle);}readConfigFromForm(){const config={};for(const key in this.dom.inputs){const input=this.dom.inputs[key];if(!input)continue;config[key]=input.type==='number'?parseInt(input.value,10):input.value;}config.autoStart=this.dom.autoStartToggle&&this.dom.autoStartToggle.classList.contains('active');config.soundEnabled=this.dom.soundToggle&&this.dom.soundToggle.classList.contains('active');const active=document.querySelector('.radio-option.active');config.timerStyle=active?active.dataset.timerStyle:'digital';config.totalSessions=Number.isFinite(config.totalSessions)?config.totalSessions:DEFAULTS.totalSessions;config.workDuration=Number.isFinite(config.workDuration)?config.workDuration:DEFAULTS.workDuration;config.shortBreakDuration=Number.isFinite(config.shortBreakDuration)?config.shortBreakDuration:DEFAULTS.shortBreakDuration;config.longBreakDuration=Number.isFinite(config.longBreakDuration)?config.longBreakDuration:DEFAULTS.longBreakDuration;config.sessionsBeforeLongBreak=Number.isFinite(config.sessionsBeforeLongBreak)?config.sessionsBeforeLongBreak:DEFAULTS.sessionsBeforeLongBreak;return config;}showToast(message,type='info'){const toast=document.createElement('div');toast.className=`toast ${type}`;const icon=document.createElement('i');icon.setAttribute('data-lucide',type==='success'?'check-circle':type==='error'?'alert-circle':'info');const span=document.createElement('span');span.textContent=message;toast.appendChild(icon);toast.appendChild(span);if(this.dom.toastContainer)this.dom.toastContainer.appendChild(toast);lucide.createIcons({root:toast});setTimeout(()=>toast.remove(),3400);}applyTheme(theme){const isDark=theme==='dark'||(theme==='system'&&window.matchMedia('(prefers-color-scheme: dark)').matches);document.documentElement.dataset.theme=isDark?'dark':'light';const themeColor=isDark?'#0f0f23':'#f8f9fa';if(this.dom.themeColorMeta)this.dom.themeColorMeta.setAttribute('content',themeColor);}}class AppStore{constructor(){this.state={};this.listeners=new Set();}subscribe(fn){this.listeners.add(fn);return()=>this.listeners.delete(fn);}setState(partial){this.state={...this.state,...partial};this.listeners.forEach(l=>l(this.state));}getState(){return this.state;}}class PomodoroApp{constructor(timerWorker){this.worker=timerWorker;this.view=new View();this.store=new AppStore();this._bindWorker();this._loadInitialState();this._bindUI();this._initTheme();if(!this.store.getState().sessions||this.store.getState().sessions.length===0){this._openConfig();}}_bindWorker(){this.worker.onmessage=(e)=>{if(e.data&&e.data.type==='tick')this._tick(e.data.seconds);};}_loadInitialState(){const config=Storage.load(StorageKey.Config)||DEFAULTS;const sessionsRaw=Storage.load(StorageKey.Schedule)||[];const sessions=(sessionsRaw||[]).map(s=>({...s,startTime:new Date(s.startTime),endTime:new Date(s.endTime)}));const savedState=Storage.load(StorageKey.State);const initialState={config,sessions,currentSessionIndex:0,remainingSeconds:sessions[0]?sessions[0].duration*60:0,isRunning:false};if(sessions.length>0){const idx=savedState?.currentSessionIndex??0;initialState.currentSessionIndex=Math.min(Math.max(0,idx),sessions.length-1);initialState.remainingSeconds=savedState?.remainingSeconds??sessions[initialState.currentSessionIndex].duration*60;if(savedState?.completedSessions){sessions.forEach(s=>s.completed=savedState.completedSessions.includes(s.id));}}this.store.setState(initialState);this.view.loadConfigToForm(config);this.store.subscribe(state=>this._saveState(state));this.store.subscribe(state=>this.view.render(state));}_saveState(state){try{Storage.save(StorageKey.State,{currentSessionIndex:state.currentSessionIndex,remainingSeconds:state.remainingSeconds,completedSessions:state.sessions.filter(s=>s.completed).map(s=>s.id)});}catch(e){console.warn('Save state failed',e);}}_bindUI(){if(this.view.dom.startBtn)this.view.dom.startBtn.addEventListener('click',()=>{Utils.requestAudioContextOnGesture();this._start();});if(this.view.dom.pauseBtn)this.view.dom.pauseBtn.addEventListener('click',()=>this._pause());if(this.view.dom.skipBtn)this.view.dom.skipBtn.addEventListener('click',()=>this._skip());if(this.view.dom.resetBtn)this.view.dom.resetBtn.addEventListener('click',()=>this._reset());if(this.view.dom.configBtn)this.view.dom.configBtn.addEventListener('click',()=>{this.view.toggleConfig(true);this._openConfig();});if(this.view.dom.closeConfig)this.view.dom.closeConfig.addEventListener('click',()=>this._closeConfig());if(this.view.dom.configOverlay){this.view.dom.configOverlay.addEventListener('click',(e)=>{if(e.target===this.view.dom.configOverlay)this._closeConfig();});}if(this.view.dom.configForm)this.view.dom.configForm.addEventListener('submit',(e)=>{e.preventDefault();this._generateSchedule();});if(this.view.dom.useNowBtn)this.view.dom.useNowBtn.addEventListener('click',()=>{if(this.view.dom.inputs.startTime)this.view.dom.inputs.startTime.value=Utils.getExactCurrentTime();this.view.showToast('Start time set to current time','success');});[this.view.dom.autoStartToggle,this.view.dom.soundToggle].forEach(toggle=>{if(!toggle)return;toggle.setAttribute('role','switch');toggle.setAttribute('tabindex','0');toggle.addEventListener('click',()=>{toggle.classList.toggle('active');toggle.setAttribute('aria-checked',toggle.classList.contains('active')?'true':'false');});toggle.addEventListener('keydown',(e)=>{if(e.key===' '||e.key==='Enter'){e.preventDefault();toggle.click();}});});document.querySelectorAll('.radio-option').forEach(opt=>{opt.setAttribute('role','radio');opt.setAttribute('tabindex','0');opt.addEventListener('click',()=>{document.querySelectorAll('.radio-option').forEach(o=>{o.classList.remove('active');o.setAttribute('aria-checked','false');});opt.classList.add('active');opt.setAttribute('aria-checked','true');const style=opt.dataset.timerStyle;this.view.setTimerStyle(style);});opt.addEventListener('keydown',(e)=>{if(e.key===' '||e.key==='Enter'){e.preventDefault();opt.click();}});});document.querySelectorAll('[data-theme-set]').forEach(btn=>btn.addEventListener('click',()=>this._setTheme(btn.dataset.themeSet)));window.addEventListener('keydown',(e)=>this._handleHotkeys(e));}_handleHotkeys(e){if(e.target&&/input|textarea|select/i.test(e.target.tagName))return;const st=this.store.getState();if(e.code==='Space'){e.preventDefault();st.isRunning?this._pause():this._start();}if(e.code==='KeyS')this._skip();if(e.code==='KeyR')this._reset();}_initTheme(){const saved=Storage.load(StorageKey.Theme)||'system';this.view.applyTheme(saved);window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change',()=>{if((Storage.load(StorageKey.Theme)||'system')==='system')this.view.applyTheme('system');});}_setTheme(theme){Storage.save(StorageKey.Theme,theme);this.view.applyTheme(theme);}_generateSchedule(){this.worker.postMessage({command:'stop'});try{const config=this.view.readConfigFromForm();const sessions=ScheduleGenerator.generate(config);this.store.setState({config,sessions,currentSessionIndex:0,remainingSeconds:sessions.length>0?sessions[0].duration*60:0,isRunning:false});Storage.save(StorageKey.Config,config);Storage.save(StorageKey.Schedule,sessions);this.view.setTimerStyle(config.timerStyle);this._closeConfig();this.view.showToast('Schedule generated successfully!','success');if(config.autoStart){setTimeout(()=>{this._start();this.view.showToast('Timer started automatically','info');},600);}}catch(e){this.view.showToast(e?.message||'Failed to generate schedule','error');}}_start(){const state=this.store.getState();if(state.isRunning)return;if(!state.sessions||state.currentSessionIndex>=state.sessions.length)return;const seconds=state.remainingSeconds??state.sessions[state.currentSessionIndex].duration*60;this.worker.postMessage({command:'start',seconds});this.store.setState({isRunning:true});}_pause(){if(!this.store.getState().isRunning)return;this.worker.postMessage({command:'stop'});this.store.setState({isRunning:false});}_tick(seconds){if(seconds<0)this._completeSession();else this.store.setState({remainingSeconds:seconds});}_completeSession(){this._pause();const state=this.store.getState();if(state.config?.soundEnabled)Utils.playNotification();const sessions=state.sessions.map((s,i)=>i===state.currentSessionIndex?{...s,completed:true}:s);const next=state.currentSessionIndex+1;if(next<sessions.length){this.store.setState({sessions,currentSessionIndex:next,remainingSeconds:sessions[next].duration*60,isRunning:false});this.view.showToast(`${Utils.getSessionLabel(sessions[state.currentSessionIndex])} complete!`,'success');if(state.config?.autoStart)setTimeout(()=>this._start(),700);}else{this.store.setState({sessions,isRunning:false});this.view.showToast('All sessions completed! ðŸŽ‰','success');if(Notification&&Notification.permission==='granted'){try{navigator.serviceWorker.getRegistration().then(reg=>{if(reg&&reg.showNotification){reg.showNotification('Pomodoro: All sessions complete!',{body:'Great work â€” all sessions are done.',icon:'./icons/pomodoro-192.svg'});}else{new Notification('Pomodoro: All sessions complete!',{body:'Great work â€” all sessions are done.'});}});}catch(e){}}}}_skip(){const state=this.store.getState();const shouldAuto=state.config?.autoStart&&state.isRunning;if(!shouldAuto&&!confirm('Skip to the next session?'))return;this._pause();const next=state.currentSessionIndex+1;if(next<state.sessions.length){this.store.setState({currentSessionIndex:next,remainingSeconds:state.sessions[next].duration*60});if(shouldAuto)setTimeout(()=>this._start(),400);}else{this.view.showToast('This is the last session','info');}}_reset(){if(!confirm('Reset all progress?'))return;this._pause();const state=this.store.getState();const sessions=state.sessions.map(s=>({...s,completed:false}));this.store.setState({sessions,currentSessionIndex:0,remainingSeconds:sessions.length?sessions[0].duration*60:0,isRunning:false});this.view.showToast('Progress reset','info');}_openConfig(){this._previousFocus=document.activeElement;this.view.toggleConfig(true);const root=this.view.dom.configOverlay;this._focusable=this._getFocusable(root);if(this._focusable.length)this._focusable[0].focus();this._boundTrap=this._trapFocus.bind(this);document.addEventListener('keydown',this._boundTrap);document.querySelectorAll('main, aside, header, .particles').forEach(el=>el.setAttribute('aria-hidden','true'));}_closeConfig(){this.view.toggleConfig(false);if(this._previousFocus&&typeof this._previousFocus.focus==='function')this._previousFocus.focus();document.removeEventListener('keydown',this._boundTrap);document.querySelectorAll('main, aside, header, .particles').forEach(el=>el.removeAttribute('aria-hidden'));}_getFocusable(root){if(!root)return[];return Array.from(root.querySelectorAll('a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])')).filter(el=>!el.hasAttribute('disabled')&&el.offsetParent!==null);}_trapFocus(e){if(!this.view.dom.configOverlay||this.view.dom.configOverlay.hidden)return;if(e.key==='Escape'){e.preventDefault();this._closeConfig();return;}if(e.key!=='Tab')return;const focusable=this._focusable=this._focusable||this._getFocusable(this.view.dom.configOverlay);if(!focusable.length){e.preventDefault();return;}const first=focusable[0],last=focusable[focusable.length-1];if(e.shiftKey&&document.activeElement===first){e.preventDefault();last.focus();}else if(!e.shiftKey&&document.activeElement===last){e.preventDefault();first.focus();}}}function bootstrap(){if('serviceWorker'in navigator){navigator.serviceWorker.register('./sw.js').catch(err=>console.warn('SW registration failed',err));}let timerWorker;try{timerWorker=new Worker('./timer-worker.js');}catch(e){console.warn('Worker creation failed, using fallback interval:',e);timerWorker={_id:null,onmessage:null,postMessage(msg){if(msg.command==='start'){let seconds=msg.seconds;if(this._id)clearInterval(this._id);this._id=setInterval(()=>{seconds--;if(this.onmessage)this.onmessage({data:{type:'tick',seconds}});if(seconds<-1)clearInterval(this._id);},1000);}else if(msg.command==='stop'){if(this._id)clearInterval(this._id);this._id=null;}}};}new PomodoroApp(timerWorker);}if(document.readyState==='loading')document.addEventListener('DOMContentLoaded',bootstrap);else bootstrap();